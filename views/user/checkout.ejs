<link rel="stylesheet" href="/css/styles.css" />

<%- include('../partials/header'); -%>

<!-- Ec breadcrumb start -->
<div class="sticky-header-next-sec ec-breadcrumb section-space-mb">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="row ec_breadcrumb_inner">
          <div class="col-md-6 col-sm-12">
            <h2 class="ec-breadcrumb-title">Payment</h2>
          </div>
          <div class="col-md-6 col-sm-12">
            <!-- ec-breadcrumb-list start -->
            <ul class="ec-breadcrumb-list">
              <li class="ec-breadcrumb-item"><a href="/">Home</a></li>
              <li class="ec-breadcrumb-item active">
                <a href="/checkout">Checkout</a>
              </li>
            </ul>
            <!-- ec-breadcrumb-list end -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Ec breadcrumb end -->

<!-- Ec checkout page -->
<section class="md">
  <div class="container">
    <div class="row">
      <!-- left pannel section -->
      <div class="col-lg-9 col-md-12 ps-2-3 mb-1-9 mb-lg-0">
        <div class="common-block">
          <div class="inner-title">
            <h4 class="mb-0">Choose Payment Method</h4>
          </div>
          <a href="/test" style="color: white">test</a>
          <div id="accordion" class="accordion-style3">
            <div class="card">
              <div class="card-header" id="headingOne">
                <h5 class="mb-0">
                  <button
                    class="btn btn-link"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseOne"
                    aria-expanded="true"
                    aria-controls="collapseOne"
                  >
                    <i class="fa-solid fa-hand-holding-dollar"></i> COD
                  </button>
                </h5>
              </div>
              <div
                id="collapseOne"
                class="collapse"
                aria-labelledby="headingOne"
                data-bs-parent="#accordion"
              >
                <div class="card-body">
                  <h6 class="display-30 font-weight-600 mb-2">
                    Cash on Delivery available
                  </h6>
                  <div class="row">
                    <div class="col-sm-6">
                      <div class="form-group">
                        <label>Address</label>
                        <p><%=user_address.addreses[0].addres1%></p>
                      </div>
                    </div>
                    <div class="col-sm-6">
                      <div class="form-group">
                        <label>city</label>
                        <p><%=user_address.addreses[0].city%></p>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-sm-6">
                      <div class="form-group">
                        <label>pincode</label>
                        <p><%=user_address.addreses[0].pincode%></p>
                      </div>
                    </div>
                    <div class="col-sm-6">
                      <div class="form-group">
                        <label>Mobile </label>
                        <p><%=user_address.addreses[0].mobile%></p>
                      </div>
                    </div>
                  </div>
                  <!-- <a href="javasript:void(0)"  data-bs-target="#edit_modal" class="butn-style2 mt-3">Edit</a> -->

                  <div class="pt-3 form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="select"
                      value="COD"
                      id="reward_points"
                    />
                  </div>
                  <!-- <form method="post" action="/placeOrder/<%=addressId%>">
                    <button name="COD" value="COD" class="butn-style2 wide">
                      PlaceOrder<i class="fas fa-arrow-right ms-1"></i>
                    </button>
                  </form> -->
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header" id="headingTwo">
                <h5 class="mb-0">
                  <button
                    class="btn btn-link collapsed"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseTwo"
                    aria-expanded="false"
                    aria-controls="collapseTwo"
                  >
                    <i class="fab fa-paypal pe-2 display-29"></i>Pay with PayPal
                  </button>
                </h5>
              </div>
              <div
                id="collapseTwo"
                class="collapse"
                aria-labelledby="headingTwo"
                data-bs-parent="#accordion"
              >
                <div class="card-body">
                  <h6 class="display-30 font-weight-600 mb-2">
                    Paypal takes good care of you.
                  </h6>

                  <div class="row">
                    <div class="col-sm-6">
                      <div class="form-group">
                        <label>Email</label>
                        <p><%=user.email%></p>
                      </div>
                    </div>

                    <div class="col-sm-6">
                      <div class="form-group">
                        <label>city</label>
                        <p><%=user_address.addreses[0].city%></p>
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-sm-6">
                      <div class="form-group">
                        <label>pincode</label>
                        <p><%=user_address.addreses[0].pincode%></p>
                      </div>
                    </div>

                    <div class="col-sm-6">
                      <div class="form-group">
                        <label>Mobile </label>
                        <p><%=user_address.addreses[0].mobile%></p>
                      </div>
                    </div>
                  </div>

                  <!-- <a href="javasript:void(0)"  data-bs-target="#edit_modal" class="butn-style2 mt-3">Edit</a> -->
                  <div class="pt-3 form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="select"
                      value="Paypal"
                      id="reward_points"
                    />
                  </div>
                  <!-- <form action="/placeOrder" method="post">
                    <button
                      name="Paypal"
                      class="butn-style2 wide"
                      value="Paypal"
                    >
                      PlaceOrder<i class="fas fa-arrow-right ms-1"></i>
                    </button>
                  </form> -->
                </div>
              </div>
            </div>
          </div>

          <div class="buttons-set">
            <a href="/checkout" class="butn-style2 wide"
              ><i class="fas fa-arrow-left me-1"></i> Back</a
            >
            <a
              class="butn-style2 wide"
              style="color: white"
              target="_blank"
              onclick="placeOrder('<%=addressId%>')"
              >PlaceOrder</a
            >
          </div>
        </div>
      </div>
      <!-- end left pannel section -->

      <!-- right pannel section -->
      <div class="col-lg-3 col-12 side-bar">
        <div class="widget">
          <div class="ec-sidebar-block">
            <div class="ec-sb-title">
              <h3 class="ec-sidebar-title">Summary</h3>
            </div>
            <div class="ec-sb-block-content">
              <div class="ec-checkout-summary">
                <div>
                  <span class="text-left">Sub total</span>
                  <%if(userCart){%>
                  <span class="text-right">$<%=userCart.total%>.00</span>
                  <%}else{%>
                  <span class="text-right">$00.00</span>
                  <%}%>
                </div>
                <div>
                  <span class="text-left">Delivery Charges</span>
                  <span class="text-right">$00.00</span>
                </div>
                <div>
                  <span class="text-left">Coupon Discount</span>
                  <span class="text-right"
                    ><a class="ec-checkout-coupan">Apply Coupan</a></span
                  >
                </div>
                <div class="ec-checkout-coupan-content">
                  <form id="coupon" class="ec-checkout-coupan-form">
                    <input
                      class="ec-coupan"
                      type="text"
                      required=""
                      placeholder="Enter Your Coupan Code"
                      name="coupan"
                    />
                    <button
                      class="ec-coupan-btn button btn-primary"
                      type="submit"
                    >
                      Apply
                    </button>
                  </form>
                </div>
                <div class="ec-checkout-summary-total">
                  <span class="text-left">Total Amount</span>
                  <%if(userCart){%>
                  <span class="text-right">$<%=userCart.total%>.00</span>
                  <%}else{%>
                  <span class="text-right">$00.00</span>
                  <%}%>
                </div>
                <%if(userCart){%> <%if(userCart.usedCoupon){%>

                <div class="ec-checkout-summary-total">
                  <span style="color: red" class="text-left"
                    >Discount Price</span
                  >
                  <span style="color: red" class="text-right">
                    $<%=userCart.grandTotal%>.00</span
                  >
                </div>

                <%}else{%>
                <div class="ec-checkout-summary-total">
                  <span style="color: red" class="text-left"
                    >Discount Price</span
                  >
                  <span style="color: red" class="text-right"> $00.00</span>
                </div>
                <%}%> <%}else{%>
                <div class="ec-checkout-summary-total">
                  <span style="color: red" class="text-left"
                    >Discount Price</span
                  >
                  <span style="color: red" class="text-right"> $00.00</span>
                </div>
                <%}%>
              </div>
            </div>
          </div>

          <div></div>
        </div>
        <div id="paypal-button-container"></div>
      </div>
      <!-- end right pannel section -->
    </div>
  </div>
</section>


<script src="https://www.paypal.com/sdk/js?client-id=<%= paypalclientid %>" data-namespace="paypal_sdk"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  async function placeOrder(addresId) {
    const value = $('input[type="radio"][name="select"]:checked').val();
    event.preventDefault();
    console.log(addresId);
      axios
        .get(`/placeOrder?addresId=${addresId}&method=${value}`)
        .then((result) => {
          if (result.data.complete) {
            Swal.fire({
              title: "Item placeed",
              showClass: {
                popup: "animate__animated animate__fadeInDown",
              },
              hideClass: {
                popup: "animate__animated animate__fadeOutUp",
              },
            });
            window.location = "/complete";
          } else if (result.data.NoCart) {
            Swal.fire({
              icon: "error",
              title: "Oops...",
              text: "CART IS EMPTY",
            });
          }else if(result.data.paypal){
            paypal_sdk.Buttons({
                            createOrder: function () {
                                return fetch("/create-order", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        items: [
                                            {
                                                id: 1,
                                                amount:result.data.price,
                                            },
                                            { id: 2, amount:result.data.price},
                                        ],
                                    }),
                                }).then(res => {
                                    if (res.ok) return res.json()
                                    console.log(res.json());
                                    return res.json().then(json => Promise.reject(json))
                                }).then(({ id }) => {
                                    console.log("pp");
                                    return id
                                }).catch(e => {
                                    console.error(e)
                                })
                            },
                            onApprove: function (data, actions) {
                                console.log(data);
                                console.log(actions);
                                return actions.order.capture().then(function (details) {
                                    verifyPayment('<%=addressId%>')
                                   
                                })
                            }
                        }).render('#paypal-button-container');
          }
        });
  }

  async function verifyPayment(addresId){
    const value = $('input[type="radio"][name="select"]:checked').val();
    event.preventDefault();
    console.log("pyapal last function called");
    axios.get(`/paypalOrder?addresId=${addresId}&method=${value}`)
    .then((result) => {
          if (result.data.complete) {
            Swal.fire({
              title: "Item placeed",
              showClass: {
                popup: "animate__animated animate__fadeInDown",
              },
              hideClass: {
                popup: "animate__animated animate__fadeOutUp",
              },
            });
            window.location = "/complete";
          } else if (result.data.NoCart) {
            Swal.fire({
              icon: "error",
              title: "Oops...",
              text: "CART IS EMPTY",
            });
          }
    }).catch((err)=>{
      console.log(err)
    })
  }



  //another functon
  document.getElementById("coupon").addEventListener("submit", (e) => {
    e.preventDefault();
    let formData = new FormData(e.target);
    let data = Object.fromEntries(formData);
    axios
      .post("/coupon", {
        data,
      })
      .then((response) => {
        if (response.data.coupan) {
          Swal.fire({
            icon: "succes",
            title: "succes",
            text: "Coupon applied",
          }).then((response) => {
            // e.target.reset()
            window.location.reload();
          });
          console.log("88988888888888888");
        } else if (response.data.unique) {
          Swal.fire({
            icon: "error",
            title: "Oops...",
            text: "Coupon Used!",
          });
        } else if (response.data.couponError) {
          Swal.fire({
            title: "!invalid Coupon",
            showClass: {
              popup: "animate__animated animate__fadeInDown",
            },
            hideClass: {
              popup: "animate__animated animate__fadeOutUp",
            },
          });
          // e.target.reset()
          // window.location.reload()
          console.log("22222222222222");
        } else if (response.data.timeError) {
          Swal.fire({
            title: "Coupon have expired",
            showClass: {
              popup: "animate__animated animate__fadeInDown",
            },
            hideClass: {
              popup: "animate__animated animate__fadeOutUp",
            },
          });
          console.log("second else case");
        }
      });
    console.log(data + "i amt he data");
  });
</script>

<%- include('../partials/footer'); -%>
